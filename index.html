<!DOCTYPE html>
<html lang="th">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>เครื่องมือสร้างภาพใบหน้าด้วย AI</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <style>
       @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap');
       body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; padding: 20px; }
       .card { background-color: white; padding: 24px; border-radius: 12px; box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
       textarea, input[type="text"], input[type="password"] { border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; width: 100%; transition: border-color 0.3s; }
       textarea:focus, input:focus { border-color: #3b82f6; outline: none; }
       .btn-primary { background-color: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s, transform 0.2s; box-shadow: 0 4px 10px -2px rgba(59, 130, 246, 0.5); }
       .btn-primary:hover:not(:disabled) { background-color: #2563eb; transform: translateY(-1px); }
       .loading-ring { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; }
       @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
   </style>
   <script>
       // Function to convert File to Base64
       function fileToBase64(file) {
           return new Promise((resolve, reject) => {
               const reader = new FileReader();
               reader.readAsDataURL(file);
               reader.onload = () => resolve(reader.result.split(',')[1]);
               reader.onerror = error => reject(error);
           });
       }

       // Delay function for Exponential Backoff
       function delay(ms) {
           return new Promise(resolve => setTimeout(resolve, ms));
       }

       // Download function
       function downloadImage(imageUrl) {
           const link = document.createElement('a');
           link.href = imageUrl;
           link.download = `AI_Portrait_${new Date().toISOString().replace(/:/g, '-')}.png`;
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
       }

       // Main image generation function
       async function generateImage() {
           const userApiKey = document.getElementById('api-key-input').value.trim();
           const faceInput = document.getElementById('face-input');
           const outputDiv = document.getElementById('output');
           const generateButton = document.getElementById('generate-btn');
           const statusMessage = document.getElementById('status-message');

           outputDiv.innerHTML = '';
           statusMessage.textContent = '';
           
           if (!userApiKey) {
               statusMessage.textContent = 'กรุณาป้อน Gemini API Key ก่อนใช้งาน (API Key is required).';
               return;
           }

           if (faceInput.files.length === 0) {
               statusMessage.textContent = 'กรุณาอัปโหลดรูปภาพใบหน้า (Upload a face image).';
               return;
           }

           const files = faceInput.files[0];
           const mimeType = files.type;
           if (!mimeType.startsWith('image/')) {
               statusMessage.textContent = 'ไฟล์ที่อัปโหลดไม่ใช่รูปภาพ (Uploaded file is not an image).';
               return;
           }

           // UI feedback
           generateButton.disabled = true;
           generateButton.innerHTML = `<span class="loading-ring"></span>กำลังสร้างภาพ...`;
           statusMessage.textContent = 'กำลังประมวลผล... โปรดรอสักครู่ (Processing, please wait)';

           try {
               const base64Data = await fileToBase64(files);
               const details = document.getElementById('person-details').value.trim();
               const clothing = document.getElementById('clothing-style').value.trim();
               const scene = document.getElementById('scene').value.trim();
               const vibe = document.getElementById('vibe-lighting').value.trim();

               const thaiPrompt = `รายละเอียด: ${details}. เสื้อผ้า: ${clothing}. ฉาก: ${scene}. ฟิลลิ่ง/แสง: ${vibe}.`;
               
               const englishPrompt = `A stunning, high-definition, photorealistic portrait created using the uploaded image as a facial reference. The new image should strictly follow these descriptive elements, applying them to the face in the reference photo: ${thaiPrompt}. The style should be cinematic, emphasizing realistic skin texture, sharp details, and volumetric lighting.`;


               const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${userApiKey}`;
               
               const payload = {
                   contents: [
                       { parts: [{ text: englishPrompt }, { inlineData: { mimeType: mimeType, data: base64Data } }] }
                   ],
                   generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
               };

               let result = null;
               const maxRetries = 3;

               for (let i = 0; i < maxRetries; i++) {
                   const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                   if (response.ok) {
                       result = await response.json();
                       break;
                   } else if (response.status === 429 && i < maxRetries - 1) {
                       await delay(Math.pow(2, i) * 1000);
                   } else {
                       throw new Error(`API call failed with status ${response.status}`);
                   }
               }

               if (!result) throw new Error('ไม่สามารถเชื่อมต่อหรือรับการตอบกลับจาก AI ได้ (No response from AI).');

               const base64Image = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

               if (base64Image) {
                   const imageUrl = `data:image/png;base64,${base64Image}`;
                   
                   outputDiv.innerHTML = `
                       <div class="relative w-full h-auto">
                           <img src="${imageUrl}" alt="ภาพที่สร้างโดย AI" class="w-full h-auto object-contain rounded-lg shadow-xl"/>
                           <div class="mt-4 flex justify-center">
                               <button onclick="downloadImage('${imageUrl}')" class="px-5 py-3 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition duration-150 shadow-lg">
                                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 inline-block mr-2">
                                       <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                                   </svg>
                                   ดาวน์โหลด (บันทึก)
                               </button>
                           </div>
                       </div>
                   `;
                   statusMessage.textContent = 'สร้างภาพสำเร็จ! (Image generated successfully!)';
               } else {
                   statusMessage.textContent = 'สร้างภาพไม่สำเร็จ: AI ไม่ได้ส่งไฟล์รูปภาพกลับมา (AI did not return an image file).';
               }

           } catch (error) {
               console.error("Error during image generation:", error);
               statusMessage.textContent = `เกิดข้อผิดพลาด: ${error.message}. โปรดตรวจสอบ API Key ของคุณ`;
           } finally {
               generateButton.disabled = false;
               generateButton.innerHTML = `สร้างภาพ (Generate Image)`;
           }
       }
   </script>
</head>
<body>
   <div class="max-w-xl w-full">
       <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">เครื่องมือสร้างภาพใบหน้าด้วย AI</h1>

       <!-- API Key Input Card -->
       <div class="card bg-yellow-50 border-2 border-yellow-300">
           <label for="api-key-input" class="block text-lg font-bold mb-2 text-yellow-700">⭐ Gemini API Key (จำเป็น)</label>
           <p class="text-sm text-yellow-600 mb-3">กรุณาป้อน Key ของคุณที่นี่ เพื่อให้แอปสามารถเรียกใช้ AI ได้</p>
           <input type="password" id="api-key-input" placeholder="ป้อน Gemini API Key ของคุณที่นี่">
       </div>

       <!-- Image Upload -->
       <div class="card">
           <label for="face-input" class="block text-lg font-bold mb-3 text-blue-700">1. อัปโหลดรูปภาพใบหน้า (Face Reference)</label>
           <input type="file" id="face-input" accept="image/*" class="w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"/>
       </div>

       <!-- Prompts / Details -->
       <div class="card space-y-4">
           <h2 class="text-xl font-bold text-gray-800">2. กำหนดรายละเอียดภาพที่ต้องการ</h2>
           
           <div>
               <label for="person-details" class="block text-sm font-medium text-gray-700">รายละเอียดบุคคล (เพศ, อายุ, ลักษณะเด่น, ท่าทาง)</label>
               <textarea id="person-details" placeholder="ตัวอย่าง: ชาย, ผิวแทน, หนวดเคราบางๆ, อายุ 30, กำลังยิ้ม"></textarea>
           </div>
           
           <div>
               <label for="clothing-style" class="block text-sm font-medium text-gray-700">รูปแบบเสื้อผ้า (Clothing Style)</label>
               <textarea id="clothing-style" placeholder="ตัวอย่าง: ชุดราตรีสีแดง, เสื้อยืดเรียบๆ กับกางเกงยีนส์"></textarea>
           </div>
           
           <div>
               <label for="scene" class="block text-sm font-medium text-gray-700">ฉาก/พื้นหลัง (Scene/Background)</label>
               <textarea id="scene" placeholder="ตัวอย่าง: ในป่าสนตอนเช้า, สตูดิโอถ่ายภาพสีขาว"></textarea>
           </div>
           
           <div>
               <label for="vibe-lighting" class="block text-sm font-medium text-gray-700">ฟิลลิ่ง/แสงและสี (Vibe/Lighting/Color)</label>
               <textarea id="vibe-lighting" placeholder="ตัวอย่าง: แสงสีทองยามเย็น (Golden Hour), โทนภาพยนตร์"></textarea>
           </div>

           <div class="text-center pt-4">
               <button id="generate-btn" onclick="generateImage()" class="btn-primary w-full">
                   สร้างภาพ (Generate Image)
               </button>
           </div>
           <p id="status-message" class="text-center text-red-500 font-medium pt-2"></p>
       </div>
       
       <!-- Output -->
       <div class="card">
           <h2 class="text-xl font-bold mb-4 text-gray-800 text-center">ผลลัพธ์ของภาพ</h2>
           <div id="output" class="min-h-[300px] flex items-center justify-center bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 p-4">
               <p class="text-gray-500">ภาพที่สร้างโดย AI จะปรากฏที่นี่</p>
           </div>
       </div>
   </div>
</body>
</html>
